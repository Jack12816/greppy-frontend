var greppy={};greppy.Application=function(){};greppy.Application.prototype.dialog=function(e,t,n){var r='<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">'+'<div class="modal-dialog"><div class="modal-content"><div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>'+"{{header}}"+"</div>"+'<div class="modal-body">'+"</div>"+'<div class="modal-footer">'+"</div></div></div></div>";t=t||{};t.header=t.header||"Confirmation required";r=r.replace("{{header}}",'<h4 class="modal-title">'+t.header+"</h4>");var i=$(r);i.find(".modal-body").html(e);n=n||[{label:"Cancel","class":"btn btn-default",icon:"icon-remove",callback:t.cancel||function(e){e()}},{label:"Ok","class":"btn btn-primary",icon:"icon-ok",callback:t.ok||function(e){e()}}];n.forEach(function(e){var t=$('<a href="#" class="'+e.class+'">'+'<i class="'+e.icon+'"></i> '+e.label+"</a>");t.click(function(){e.callback(function(){i.modal("hide")});return false});i.find(".modal-footer").append(t)});$("body").append(i);i.modal({keyboard:true,show:true});i.on("hidden.bs.modal",function(){i.remove()});i.on("shown.bs.modal",function(){i.find("input:first").focus()})};greppy.Controller=function(e){var t=this;Object.keys(e).forEach(function(n){t[n]=e[n]})};greppy.Controller.prototype.link=function(e,t){if(!this.actions.hasOwnProperty(e)){throw new Error('Action "'+e+'" is not registered for the controller');return}var n=this.basePath+this.actions[e].path;if(t){Object.keys(t).forEach(function(e){n=n.replace(new RegExp(":"+e+"[?]?","ig"),t[e])})}return n};greppy.DataGrid=function(e,t){this.table=e;this.search=new greppy.Search(this,e);this.sort=new greppy.Sort(this,e);this.paginate=new greppy.Paginator(this,e);this.options=t;this.options.softDeletion="undefined"!==typeof t.softDeletion?t.softDeletion:true;this.initOverlay();$(".btn").on({change:function(e){setTimeout(function(){$(e.currentTarget).trigger("g.change")},20)}})};greppy.DataGrid.prototype.buildUrl=function(e){var t=this;var n=document.URL;e=e||[];if(this.options.softDeletion){if(true==$("#search-trash label").hasClass("active")){e.unshift({name:"filter",value:"trash"})}}if(-1===document.URL.indexOf("?")){n+="?"}e.forEach(function(e){n+="&"+e.name+"="+encodeURIComponent(e.value)});return n};greppy.DataGrid.prototype.loadAndRebuild=function(e){var t=this;e=e||[];e.unshift({name:"render",value:"rows"});this.paginate.load();$.ajax({type:"GET",url:this.buildUrl(e)}).done(function(e){t.table.find("tr").not(":first").remove();t.table.find("tbody").append(e);t.table.trigger("g.datagrid.rebuilt")});this.table.trigger("g.datagrid.loading")};greppy.DataGrid.prototype.reset=function(){this.loadAndRebuild(this.paginate.getParameters());this.paginate.load(1)};greppy.DataGrid.prototype.load=function(){var e=[];e=e.concat(this.search.getParameters());e=e.concat(this.sort.getParameters());e=e.concat(this.paginate.getParameters());this.loadAndRebuild(e)};greppy.DataGrid.prototype.initOverlay=function(){var e=this;var t="gOverlay";this.table.on({"g.datagrid.loading":function(){e.table.find("#"+t).remove();e.table.after('<div id="'+t+'" />');$("#"+t).css({background:"#fff",opacity:"0.6",position:"absolute",top:e.table.position().top,left:e.table.position().left,width:e.table.outerWidth(),height:e.table.outerHeight()});e.initSpinner(document.getElementById(t))},"g.datagrid.rebuilt":function(){$("#"+t).remove()}})};greppy.DataGrid.prototype.initSpinner=function(e){var t={lines:12,length:20,width:5,radius:20};this.spinner=(new Spinner(t)).spin(e)};greppy.Search=function(e,t){var n=this;this.datagrid=e;this.datagridElement=t;this.input=$("#search-input");this.trash=$("#search-trash");this.datagridElement.find($("th[data-property]")).each(function(e,t){var n=$(t);n.html($("<span> "+n.text()+" </span>"));n.prepend($('<i class="search-trigger icon-search text-muted"></i>'))});$("#search-trash").on("g.change",function(){n.datagrid.paginate.page=1;n.datagrid.load()});$("#search-btn").on("click",function(){n.datagrid.paginate.page=1;n.datagrid.load()});$(".search-trigger").on("click",function(){var e=$(this).parent();n.settings(e.attr("data-property"),e.text());$("#search-input").focus()});$("#search-clear").on("click",function(){n.clear();n.settings("fuzzy");n.datagrid.reset()});$("#search-input").keypress(function(e){if(e.keyCode==13){$("#search-btn").trigger("click")}})};greppy.Search.prototype.settings=function(e,t){if("fuzzy"==e){t="Fuzzy search"}else{t="Search for"+t.toLowerCase()}this.input.attr("placeholder",t+"..").attr("data-property",e)};greppy.Search.prototype.clear=function(){this.input.val("")};greppy.Search.prototype.getParameters=function(){var e=[];if(""==this.input.val()){return e}var e=e.concat([{name:"search",value:this.input.val()},{name:"sprop",value:this.input.attr("data-property")}]);return e};greppy.Sort=function(e,t){var n=this;this.datagrid=e;this.datagridElement=t;this.datagridElement.find($("th[data-property] span")).on("click",function(){n.toggle($(this).parent())})};greppy.Sort.prototype.toggle=function(e){this.datagridElement.find($("th[data-property]")).not(e).each(function(e,t){t=$(t);t.find(".direction").remove();t.attr("data-sort","")});var t=e.attr("data-sort");if(!t){e.append($('<i class="direction text-muted icon-arrow-down"></i>'));e.attr("data-sort","asc")}if("asc"===t){e.find(".direction").removeClass("icon-arrow-down").addClass("icon-arrow-up");e.attr("data-sort","desc")}if("desc"===t){e.find(".direction").remove();e.attr("data-sort","")}if(!e.attr("data-sort")){return this.datagrid.reset()}this.datagrid.load()};greppy.Sort.prototype.getParameters=function(){var e=this.datagridElement.find($("th[data-property]")).not($('[data-sort=""]'));if(0===e.length||!e.attr("data-sort")||""==e.attr("data-sort")){return[]}return[{name:"order",value:e.attr("data-sort")},{name:"oprop",value:e.attr("data-property")}]};greppy.Paginator=function(e,t){var n=this;var r=$(document);this.datagrid=e;this.datagridElement=t;this.page=1;r.on("click",".pagination a[data-page]",function(){n.page=$(this).attr("data-page");n.datagrid.load();n.load()});r.on("change","#pagination-limit",function(){n.datagrid.load()});r.on("keydown",function(e){if($("input, textarea").is(":focus")){return}if(37==e.keyCode){n.page=n.page>0?n.page-1:1;n.datagrid.load();n.load()}if(39==e.keyCode){var t=1;$(".pagination a[data-page]").each(function(e,n){var r=parseInt($(n).attr("data-page"));t=t<r?r:t});n.page=n.page<t?n.page+1:n.page;n.datagrid.load();n.load()}if(71==e.keyCode){greppy.app.dialog(['<div class="col-lg-5">','<input autofocus="autofocus" class="form-control" id="page-to-jump" ',' name="page-to-jump" type="number" placeholder="Page to jump to ..">',"</div><br />"].join(""),{header:"Quick page jump",ok:function(e){n.page=parseInt($("#page-to-jump").val());n.datagrid.load();n.load();e&&e()}})}})};greppy.Paginator.prototype.load=function(e){var t=[];t=t.concat(this.datagrid.search.getParameters());t=t.concat(this.datagrid.sort.getParameters());t=t.concat(this.datagrid.paginate.getParameters(e));t.unshift({name:"render",value:"pagination"});$.ajax({type:"GET",url:this.datagrid.buildUrl(t)}).done(function(e){$(".paginator").html(e)})};greppy.Paginator.prototype.getParameters=function(e){return[{name:"page",value:e||this.page},{name:"limit",value:$("#pagination-limit :selected").val()}]};greppy.Styler=function(){};greppy.Styler.prototype.styleUpload=function(e){e=this.validateStyleUpload(e);var t='div[data-fileuploadname="'+e.name+'"]';var n='<div class="input-group" data-fileuploadname="'+e.name+'">'+'<span class="input-group-addon"><i class="icon-file"></i></span>'+'<div class="form-control"><span class="file-path"></span></div>'+'<span class="input-group-btn">'+'<button id="myBtn" class="btn btn-default">Datei wählen</button>'+"</span>"+"</div>";e.after(n);e.on("change",function(){$(t+" .file-path").text($(this).val().split("\\").pop())});$(t+" button").on("click",function(){e.trigger("click");return false})};greppy.Styler.prototype.validateStyleUpload=function(e){var t=new greppy.Sanitizer;var n;e=t.toJquery(e);t.assertSingle(e);n=e.attr("name");if(!n||$('*[name="'+n+'"]').length>1){throw new Error("Element needs to have a unique name!")}return e};greppy.Sanitizer=function(){};greppy.Sanitizer.prototype.toJquery=function(e){e="string"==typeof e?$(e):e;if("undefined"===typeof e||e.length===0){throw new Error("No element(s) found!")}return e};greppy.Sanitizer.prototype.assertSingle=function(e){if(e.length!==1){throw new Error("Expected 1 element, got "+e.length)}};greppy.app=new greppy.Application