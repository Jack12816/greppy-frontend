/*! @name greppy-frontend * @date 2014-08-12 14:07 * @version 0.11.1 */var greppy={};greppy.Application=function(){},greppy.Application.prototype.dialog=function(a,b,c){b=b||{},b.header=b.header||"Confirmation required",b.keyboard="undefined"==typeof b.keyboard?!0:b.keyboard,b.show="undefined"==typeof b.show?!0:b.show,b.closeBtn="undefined"==typeof b.closeBtn?!0:b.closeBtn,b.template=b.template||'<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header">'+(!1===b.closeBtn?"":'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>')+"{{header}}"+"</div>"+'<div class="modal-body">'+"</div>"+'<div class="modal-footer">'+"</div></div></div></div>",b.template=b.template.replace("{{header}}",'<h4 class="modal-title">'+b.header+"</h4>");var d=$(b.template);return d.find(".modal-body").html(a),c=c||[{label:"Cancel","class":"btn btn-default",icon:"fa-times",callback:b.cancel||function(a){a()}},{label:"Ok","class":"btn btn-primary",icon:"fa-check",callback:b.ok||function(a){a()}}],c.forEach(function(a){var b=$('<a href="#" class="'+a.class+'">'+'<i class="fa '+a.icon+'"></i> '+a.label+"</a>");b.click(function(){return a.callback(function(){d.modal("hide")}),!1}),d.find(".modal-footer").append(b)}),$("body").append(d),console.log(b),d.modal(b),d.on("hidden.bs.modal",function(){return"function"==typeof b.close?b.close(function(){d.remove()}):(d.remove(),void 0)}),d.on("shown.bs.modal",function(){d.find("input:first").focus()}),d},greppy.Controller=function(a){var b=this;Object.keys(a).forEach(function(c){b[c]=a[c]})},greppy.Controller.prototype.link=function(a,b){if(!this.actions.hasOwnProperty(a))throw new Error('Action "'+a+'" is not registered for the controller');var c=this.basePath+this.actions[a].path;return b&&Object.keys(b).forEach(function(a){c=c.replace(new RegExp(":"+a+"[?]?","ig"),b[a])}),c},greppy.Validator=function(){},greppy.Validator.prototype.init=function(){var a=this;this.allValidators=$("input, select, textarea").filter(".greppy-validator"),this.events=[],this.bindEvent("invalid","gValidationInvalid"),this.bindEvent("change","gValidationUpdate"),this.bindEvent("keyup","gValidationUpdate"),$(document).on({gValidationUpdate:function(b){a.validate(b.target)},gValidationInvalid:function(b){a.markInvalid(a.getMark(b.target)),a.showMsg(b.target),b.preventDefault()}})},greppy.Validator.prototype.bindEvent=function(a,b){var c=this;if("gValidationInvalid"!==b&&"gValidationUpdate"!==b)throw new Error("No such Greppy validator event exists: "+b);this.events.push({origEvtName:a,gEvtName:b}),$(this.allValidators).each(function(d,e){c.bindEventToValidator(e,a,b)})},greppy.Validator.prototype.bindEventToValidator=function(a,b,c){a=$(a),a.on(b,function(a){$(this).trigger(c),"gValidationInvalid"===c&&a.preventDefault()})},greppy.Validator.prototype.getMark=function(a){a=$(a);var b,c=a.attr("name");return null===c?a:(b=a.parents('*[data-greppy-validator-mark="'+c+'"]'),0===b.length&&a.hasClass("multiselect")&&(b=a.nextAll(".btn-group")),0<b.length?b:a)},greppy.Validator.prototype.addValidator=function(a){if(!$(a).hasClass("greppy-validator"))throw new Error("Element passed is not a Greppy validator!");this.allValidators.add(a),this.bindAllEventsToValidator(a)},greppy.Validator.prototype.bindAllEventsToValidator=function(a){var b=this;this.events.forEach(function(c){b.bindEventToValidator(a,c.origEvtName,c.gEvtName)})},greppy.Validator.prototype.validate=function(a){return!1===a.checkValidity()?(this.markInvalid(this.getMark(a)),void 0):(this.removeInvalidMark(this.getMark(a)),this.removeMsg(this.getMark(a)),void 0)},greppy.Validator.prototype.markInvalid=function(a){$(a).addClass("greppy-validator-invalid")},greppy.Validator.prototype.removeInvalidMark=function(a){$(a).removeClass("greppy-validator-invalid")},greppy.Validator.prototype.showMsg=function(a){a=$(a);var b=this.getMark(a),c=this;this.hasActiveMsg(a)||$('<div class="greppy-validator-msg btn btn-danger" data-greppy-validator-name="'+a.attr("name")+'" />').html(b.attr("data-greppy-validator-msg")||a.attr("data-greppy-validator-msg")||"Validation failed").insertAfter(b).hide().fadeIn().css({top:b.position().top+b.outerHeight()+4,left:b.position().left}).on("mouseleave",function(){c.removeMsg(b)})},greppy.Validator.prototype.hasActiveMsg=function(a){var b=a.attr("name"),c=this.getMark(a);return b&&c.nextAll('.greppy-validator-msg[data-greppy-validator-name="'+b+'"]').length?!0:!1},greppy.Validator.prototype.removeMsg=function(a,b){return a=$(a).nextAll(".greppy-validator-msg"),b?(a.remove(),void 0):(a.fadeOut(function(){a.remove()}),void 0)},greppy.DataGrid=function(a,b){var c=new greppy.Styler;this.table=a,this.search=new greppy.DataGrid.Search(this,a),this.sort=new greppy.DataGrid.Sort(this,a),this.paginator=new greppy.DataGrid.Pagination(this,a),this.options=b||{},this.options.softDeletion="undefined"!=typeof b.softDeletion?b.softDeletion:!0,this.options.url=b.url||document.URL,this.options.labels&&this.setProvidedLabels(),0<a.length&&c.initOverlay(this.table,"gDatagridLoading","gDatagridRebuilt"),$(".btn").on({change:function(a){setTimeout(function(){$(a.currentTarget).trigger("gChange")},20)}})},greppy.DataGrid.prototype.buildUrl=function(a){var b=this.options.url;return a=a||[],this.options.softDeletion&&!0===$("#search-trash label").hasClass("active")&&a.unshift({name:"filter",value:"trash"}),-1===document.URL.indexOf("?")&&(b+="?"),a.forEach(function(a){a.value&&(b+="&"+a.name+"="+encodeURIComponent(a.value))}),b},greppy.DataGrid.prototype.loadAndRebuild=function(a,b){this.table.trigger("gDatagridLoading"),a=a||[];var c=function(a){$.ajax({type:"GET",url:a}).done(b)},d=this.buildUrl(a);"function"==typeof this.options.preLoad?this.options.preLoad(d,function(a,b){a||c(b)}):c(d)},greppy.DataGrid.prototype.reset=function(){var a=this,b=function(){a.load(!0,!0,1)};"function"==typeof this.options.preReset?this.options.preReset(function(a){a||b()}):b()},greppy.DataGrid.prototype.load=function(a,b,c){var d=this,e=[];if("undefined"==typeof a&&(a=!0),"undefined"==typeof b&&(b=!0),e=e.concat(this.search.getParameters()),e=e.concat(this.sort.getParameters()),e=e.concat(this.paginator.getParameters(c)),!0===a){var f=[].concat(e);f.unshift({name:"render",value:"rows"}),this.loadAndRebuild(f,function(a){d.table.find("tr").not(":first").remove(),d.table.find("tbody").append(a),d.table.trigger("gDatagridRebuilt")})}if(!0===b){var g=[].concat(e);g.unshift({name:"render",value:"pagination"}),this.loadAndRebuild(g,function(a){$(".paginator").html(a)})}},greppy.DataGrid.prototype.setProvidedLabels=function(){for(var a in this.options.labels)this[a]&&this[a].setLabels&&this[a].setLabels(this.options.labels[a])},greppy.DataGrid.Pagination=function(a,b){var c=this,d=$(document);this.datagrid=a,this.datagridElement=b,this.page=1,d.on("click",".pagination a[data-page]",function(){var a=$(this).attr("data-page");c.page!=a&&(c.page=$(this).attr("data-page"),c.datagrid.load())}),d.on("change","#pagination-limit",function(){c.datagrid.reset()}),d.on("keydown",function(a){if(!$("input, textarea").is(":focus")){if(37==a.keyCode&&(c.page=c.page>0?c.page-1:1,c.datagrid.load()),39==a.keyCode){var b=1;$(".pagination a[data-page]").each(function(a,c){var d=parseInt($(c).attr("data-page"));b=d>b?d:b}),c.page=c.page<b?c.page+1:c.page,c.datagrid.load()}71==a.keyCode&&greppy.app.dialog(['<div class="col-lg-5">','<input autofocus="autofocus" class="form-control" id="page-to-jump" ',' name="page-to-jump" type="number" placeholder="Page to jump to ..">',"</div><br />"].join(""),{header:"Quick page jump",ok:function(a){c.page=parseInt($("#page-to-jump").val()),c.datagrid.load(),a&&a()}})}})},greppy.DataGrid.Pagination.prototype.getParameters=function(a){return[{name:"page",value:a||this.page},{name:"limit",value:$("#pagination-limit :selected").val()}]},greppy.DataGrid.Search=function(a,b){var c=this;this.datagrid=a,this.datagridElement=b,this.input=$("#search-input"),this.trash=$("#search-trash"),this.labels={fuzzySearch:"Fuzzy search",searchFor:"Search for"},this.datagridElement.find($("th[data-property]")).each(function(a,b){var c=$(b);c.html($("<span>&nbsp;"+c.text()+"&nbsp;</span>")),c.prepend($('<i class="search-trigger fa fa-search text-muted"></i>'))}),$("#search-trash").on("gChange",function(){c.datagrid.paginator.page=1,c.datagrid.load()}),$("#search-btn").on("click",function(){c.datagrid.paginator.page=1,c.datagrid.load()}),$(".search-trigger").on("click",function(){var a=$(this).parent();c.settings(a.attr("data-property"),a.text()),$("#search-input").focus()}),$("#search-clear").on("click",function(){c.clear(),c.settings("fuzzy"),c.datagrid.reset()}),$("#search-input").keypress(function(a){13==a.keyCode&&$("#search-btn").trigger("click")})},greppy.DataGrid.Search.prototype.settings=function(a,b){b="fuzzy"==a?this.labels.fuzzySearch:this.labels.searchFor+b.toLowerCase(),this.input.attr("placeholder",b+"..").attr("data-property",a)},greppy.DataGrid.Search.prototype.clear=function(){this.input.val("")},greppy.DataGrid.Search.prototype.getParameters=function(){var a=[];if(""==this.input.val())return a;var a=a.concat([{name:"search",value:this.input.val().trim()},{name:"sprop",value:this.input.attr("data-property")}]);return a},greppy.DataGrid.Search.prototype.setLabels=function(a){$.extend(!0,this.labels,a)},greppy.DataGrid.Sort=function(a,b){var c=this;this.datagrid=a,this.datagridElement=b,this.datagridElement.find($("th[data-property] span")).on("click",function(){c.toggle($(this).parent())})},greppy.DataGrid.Sort.prototype.toggle=function(a){this.datagridElement.find($("th[data-property]")).not(a).each(function(a,b){b=$(b),b.find(".direction").remove(),b.attr("data-sort","")});var b=a.attr("data-sort");return b||(a.append($('<i class="direction text-muted fa fa-arrow-down"></i>')),a.attr("data-sort","asc")),"asc"===b&&(a.find(".direction").removeClass("fa-arrow-down").addClass("fa-arrow-up"),a.attr("data-sort","desc")),"desc"===b&&(a.find(".direction").remove(),a.attr("data-sort","")),a.attr("data-sort")?(this.datagrid.load(),void 0):this.datagrid.reset()},greppy.DataGrid.Sort.prototype.getParameters=function(){var a=this.datagridElement.find($("th[data-property]")).not($('[data-sort=""]'));return 0!==a.length&&a.attr("data-sort")&&""!=a.attr("data-sort")?[{name:"order",value:a.attr("data-sort")},{name:"oprop",value:a.attr("data-property")}]:[]},greppy.Styler=function(){this.upload=new greppy.Styler.Upload,this.number=new greppy.Styler.Number},greppy.Styler.prototype.initOverlay=function(a,b,c){var d=this,e="gOverlay"+(new Date).getTime(),f={};if(a=$(a),1!==a.length)throw new Error("Expected single element for overlay, but got "+a.length);f[b]=function(){a.parent().find("#"+e).remove(),a.after('<div class="greppy-overlay" id="'+e+'" />'),$("#"+e).css({top:a.position().top,left:a.position().left,width:a.outerWidth(),height:a.outerHeight()}),d.initSpinner(document.getElementById(e))},f[c]=function(){$("#"+e).remove()},a.on(f)},greppy.Styler.prototype.initSpinner=function(a,b){b=b||{lines:11,length:0,width:10,radius:30,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:29,shadow:!1,hwaccel:!0,className:"spinner",zIndex:2e9},this.spinner=new Spinner(b).spin(a)},greppy.Styler.Number=function(){},greppy.Styler.Number.prototype.style=function(a){var b=this;a=$(a),a.each(function(a,c){c=$(c),b.validate(c),b.handleCleanup(c),b.addStyles(c),b.addButtonHandlers(c)})},greppy.Styler.Number.prototype.validate=function(a){if("INPUT"!==a.prop("tagName"))throw new Error("Element needs to be an input")},greppy.Styler.Number.prototype.handleCleanup=function(a){this.isNumber(a)&&this.clearStyled(a)},greppy.Styler.Number.prototype.addStyles=function(a){a.wrap('<div class="input-group greppy-container-num" data-greppy-validator-mark="'+a.attr("name")+'"></div>'),a.addClass("pull-left"),a.after('<div class="input-group-btn pull-left"><button class="btn btn-default g-add" type="button"><i class="fa fa-plus"></i></button>&nbsp;<button class="btn btn-default g-substract" type="button"><i class="fa fa-minus"></i></button></div>')},greppy.Styler.Number.prototype.addButtonHandlers=function(a){var b=this;a.next(".input-group-btn").find(".g-add").on("click",function(){var c=b.getAddedVal(a);a.val(c).trigger("change")}),a.next(".input-group-btn").find(".g-substract").on("click",function(){var c=b.getSubtractedVal(a);a.val(c).trigger("change")})},greppy.Styler.Number.prototype.getVal=function(a){return isNaN(parseInt(a.val(),10))?0:parseInt(a.val(),10)},greppy.Styler.Number.prototype.getAddedVal=function(a){var b=this.getVal(a);return a.attr("data-max")<b+1?b:b+1},greppy.Styler.Number.prototype.getSubtractedVal=function(a){var b=this.getVal(a);return a.attr("data-min")>b-1?b:b-1},greppy.Styler.Number.prototype.isNumber=function(a){return a.parent().hasClass("greppy-container-num")?!0:!1},greppy.Styler.Number.prototype.clearStyled=function(a){a.unwrap(),a.next(".input-group-btn").remove(),a.off()},greppy.Styler.Upload=function(){},greppy.Styler.Upload.prototype.style=function(a){var b=this;a=$(a),a.each(function(a,c){c=$(c),b.validate(c),b.addStyles(c),b.handleFilePreselected(c),b.addNewFileSelectedHandler(c),b.addButtonHandlers(c),b.hideOriginalInput(c)})},greppy.Styler.Upload.prototype.validate=function(a){var b=a.attr("name");if(!b||$('*[name="'+b+'"]').length>1)throw new Error("Element needs to have a unique name")},greppy.Styler.Upload.prototype.addStyles=function(a){var b=this.getMarkup(a);a.wrap(b)},greppy.Styler.Upload.prototype.getMarkup=function(a){return'<div class="input-group" data-fileuploadname="'+a.attr("name")+'"'+' data-greppy-validator-mark="'+a.attr("name")+'">'+'<span class="input-group-addon"><i class="fa fa-file"></i></span>'+'<div class="form-control"><span class="file-path"></span></div>'+'<span class="input-group-btn">'+'<button class="btn btn-default" type="button">Datei wählen</button>'+"</span>"+"</div>"},greppy.Styler.Upload.prototype.showFilename=function(a){$(this.getStyledUploadSelector(a)+" .file-path").text(a.val().split("\\").pop())},greppy.Styler.Upload.prototype.getStyledUploadSelector=function(a){return'div[data-fileuploadname="'+a.attr("name")+'"]'},greppy.Styler.Upload.prototype.handleFilePreselected=function(a){a.val()&&this.showFilename(a)},greppy.Styler.Upload.prototype.addNewFileSelectedHandler=function(a){var b=this;a.on("change",function(){b.showFilename(a)})},greppy.Styler.Upload.prototype.addButtonHandlers=function(a){var b=this,c=this.getStyledUploadSelector(a);$(c+" button, "+c+" .form-control").on("click",function(c){$(c.target).is(a)||b.showFileDialog(a)})},greppy.Styler.Upload.prototype.showFileDialog=function(a){a.trigger("click")},greppy.Styler.Upload.prototype.hideOriginalInput=function(a){a.hide()},greppy.app=new greppy.Application;