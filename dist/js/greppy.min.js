var greppy={};greppy.Application=function(){};greppy.Application.prototype.dialog=function(body,options,buttons){var template='<div class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">'+'<div class="modal-dialog"><div class="modal-content"><div class="modal-header">'+'<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>'+"{{header}}"+"</div>"+'<div class="modal-body">'+"</div>"+'<div class="modal-footer">'+"</div></div></div></div>";options=options||{};options.header=options.header||"Confirmation required";template=template.replace("{{header}}",'<h4 class="modal-title">'+options.header+"</h4>");var modal=$(template);modal.find(".modal-body").html(body);buttons=buttons||[{label:"Cancel","class":"btn btn-default",icon:"icon-remove",callback:options.cancel||function(callback){callback()}},{label:"Ok","class":"btn btn-primary",icon:"icon-ok",callback:options.ok||function(callback){callback()}}];buttons.forEach(function(btn){var btnObj=$('<a href="#" class="'+btn.class+'">'+'<i class="'+btn.icon+'"></i> '+btn.label+"</a>");btnObj.click(function(){btn.callback(function(){modal.modal("hide")});return false});modal.find(".modal-footer").append(btnObj)});$("body").append(modal);modal.modal({keyboard:true,show:true});modal.on("hidden.bs.modal",function(){modal.remove()});modal.on("shown.bs.modal",function(){modal.find("input:first").focus()})};greppy.Controller=function(options){var self=this;Object.keys(options).forEach(function(key){self[key]=options[key]})};greppy.Controller.prototype.link=function(action,params){if(!this.actions.hasOwnProperty(action)){throw new Error('Action "'+action+'" is not registered for the controller');return}var link=this.basePath+this.actions[action].path;if(params){Object.keys(params).forEach(function(param){link=link.replace(new RegExp(":"+param+"[?]?","ig"),params[param])})}return link};greppy.DataGrid=function(table,options){var s=new greppy.Styler;this.table=table;this.search=new greppy.Search(this,table);this.sort=new greppy.Sort(this,table);this.paginate=new greppy.Paginator(this,table);this.options=options;this.options.softDeletion="undefined"!==typeof options.softDeletion?options.softDeletion:true;s.initOverlay(this.table,"loading.datagrid.g","rebuilt.datagrid.g");$(".btn").on({change:function(e){setTimeout(function(){$(e.currentTarget).trigger("change.g")},20)}})};greppy.DataGrid.prototype.buildUrl=function(params){var self=this;var url=document.URL;params=params||[];if(this.options.softDeletion){if(true==$("#search-trash label").hasClass("active")){params.unshift({name:"filter",value:"trash"})}}if(-1===document.URL.indexOf("?")){url+="?"}params.forEach(function(param){url+="&"+param.name+"="+encodeURIComponent(param.value)});return url};greppy.DataGrid.prototype.loadAndRebuild=function(params){var self=this;params=params||[];params.unshift({name:"render",value:"rows"});this.paginate.load();$.ajax({type:"GET",url:this.buildUrl(params)}).done(function(data){self.table.find("tr").not(":first").remove();self.table.find("tbody").append(data);self.table.trigger("rebuilt.datagrid.g")});this.table.trigger("loading.datagrid.g")};greppy.DataGrid.prototype.reset=function(){this.loadAndRebuild(this.paginate.getParameters());this.paginate.load(1)};greppy.DataGrid.prototype.load=function(){var params=[];params=params.concat(this.search.getParameters());params=params.concat(this.sort.getParameters());params=params.concat(this.paginate.getParameters());this.loadAndRebuild(params)};greppy.Paginator=function(datagrid,datagridElement){var self=this;var doc=$(document);this.datagrid=datagrid;this.datagridElement=datagridElement;this.page=1;doc.on("click",".pagination a[data-page]",function(){self.page=$(this).attr("data-page");self.datagrid.load()});doc.on("change","#pagination-limit",function(){self.page=1;self.datagrid.load()});doc.on("keydown",function(e){if($("input, textarea").is(":focus")){return}if(37==e.keyCode){self.page=self.page>0?self.page-1:1;self.datagrid.load();self.load()}if(39==e.keyCode){var maxPage=1;$(".pagination a[data-page]").each(function(idx,itm){var val=parseInt($(itm).attr("data-page"));maxPage=maxPage<val?val:maxPage});self.page=self.page<maxPage?self.page+1:self.page;self.datagrid.load();self.load()}if(71==e.keyCode){greppy.app.dialog(['<div class="col-lg-5">','<input autofocus="autofocus" class="form-control" id="page-to-jump" ',' name="page-to-jump" type="number" placeholder="Page to jump to ..">',"</div><br />"].join(""),{header:"Quick page jump",ok:function(callback){self.page=parseInt($("#page-to-jump").val());self.datagrid.load();self.load();callback&&callback()}})}})};greppy.Paginator.prototype.load=function(page){var params=[];params=params.concat(this.datagrid.search.getParameters());params=params.concat(this.datagrid.sort.getParameters());params=params.concat(this.datagrid.paginate.getParameters(page));params.unshift({name:"render",value:"pagination"});$.ajax({type:"GET",url:this.datagrid.buildUrl(params)}).done(function(data){$(".paginator").html(data)})};greppy.Paginator.prototype.getParameters=function(page){return[{name:"page",value:page||this.page},{name:"limit",value:$("#pagination-limit :selected").val()}]};greppy.Search=function(datagrid,datagridElement){var self=this;this.datagrid=datagrid;this.datagridElement=datagridElement;this.input=$("#search-input");this.trash=$("#search-trash");this.datagridElement.find($("th[data-property]")).each(function(idx,itm){var th=$(itm);th.html($("<span>&nbsp;"+th.text()+"&nbsp;</span>"));th.prepend($('<i class="search-trigger icon-search text-muted"></i>'))});$("#search-trash").on("change.g",function(e){if("g"!==e.namespace){return false}self.datagrid.paginate.page=1;self.datagrid.load()});$("#search-btn").on("click",function(){self.datagrid.paginate.page=1;self.datagrid.load()});$(".search-trigger").on("click",function(){var cur=$(this).parent();self.settings(cur.attr("data-property"),cur.text());$("#search-input").focus()});$("#search-clear").on("click",function(){self.clear();self.settings("fuzzy");self.datagrid.reset()});$("#search-input").keypress(function(event){if(event.keyCode==13){$("#search-btn").trigger("click")}})};greppy.Search.prototype.settings=function(property,placeholder){if("fuzzy"==property){placeholder="Fuzzy search"}else{placeholder="Search for"+placeholder.toLowerCase()}this.input.attr("placeholder",placeholder+"..").attr("data-property",property)};greppy.Search.prototype.clear=function(){this.input.val("")};greppy.Search.prototype.getParameters=function(){var params=[];if(""==this.input.val()){return params}var params=params.concat([{name:"search",value:this.input.val()},{name:"sprop",value:this.input.attr("data-property")}]);return params};greppy.Sort=function(datagrid,datagridElement){var self=this;this.datagrid=datagrid;this.datagridElement=datagridElement;this.datagridElement.find($("th[data-property] span")).on("click",function(){self.toggle($(this).parent())})};greppy.Sort.prototype.toggle=function(th){this.datagridElement.find($("th[data-property]")).not(th).each(function(idx,item){item=$(item);item.find(".direction").remove();item.attr("data-sort","")});var dir=th.attr("data-sort");if(!dir){th.append($('<i class="direction text-muted icon-arrow-down"></i>'));th.attr("data-sort","asc")}if("asc"===dir){th.find(".direction").removeClass("icon-arrow-down").addClass("icon-arrow-up");th.attr("data-sort","desc")}if("desc"===dir){th.find(".direction").remove();th.attr("data-sort","")}if(!th.attr("data-sort")){return this.datagrid.reset()}this.datagrid.load()};greppy.Sort.prototype.getParameters=function(){var th=this.datagridElement.find($("th[data-property]")).not($('[data-sort=""]'));if(0===th.length||!th.attr("data-sort")||""==th.attr("data-sort")){return[]}return[{name:"order",value:th.attr("data-sort")},{name:"oprop",value:th.attr("data-property")}]};greppy.Sanitizer=function(){};greppy.Sanitizer.prototype.toJquery=function(elem){elem="string"===typeof elem?$(elem):elem;if("undefined"===typeof elem||elem.length===0){throw new Error("No element(s) found!")}return elem};greppy.Sanitizer.prototype.assertSingle=function(elem){if(elem.length!==1){throw new Error("Expected 1 element, got "+elem.length)}};greppy.Styler=function(){};greppy.Styler.prototype.styleUpload=function(elem){elem=this.validateStyleUpload(elem);var newUploadSel='div[data-fileuploadname="'+elem.name+'"]';var markup='<div class="input-group" data-fileuploadname="'+elem.name+'">'+'<span class="input-group-addon"><i class="icon-file"></i></span>'+'<div class="form-control"><span class="file-path"></span></div>'+'<span class="input-group-btn">'+'<button id="myBtn" class="btn btn-default">Datei w√§hlen</button>'+"</span>"+"</div>";elem.after(markup);elem.on("change",function(){$(newUploadSel+" .file-path").text($(this).val().split("\\").pop())});$(newUploadSel+" button, "+newUploadSel+" .form-control").on("click",function(){elem.trigger("click");return false});elem.hide()};greppy.Styler.prototype.validateStyleUpload=function(elem){var s=new greppy.Sanitizer;var name;elem=s.toJquery(elem);s.assertSingle(elem);name=elem.attr("name");if(!name||$('*[name="'+name+'"]').length>1){throw new Error("Element needs to have a unique name!")}return elem};greppy.Styler.prototype.initOverlay=function(el,showEvent,removeEvent){var s=new greppy.Sanitizer;var self=this;var overlayId="gOverlay"+(new Date).getTime();var evts={};el=s.toJquery(el);s.assertSingle(el);evts[showEvent]=function(){el.parent().find("#"+overlayId).remove();el.after('<div id="'+overlayId+'" />');$("#"+overlayId).css({background:"rgba(255, 255, 255, 0.6)",position:"absolute",top:el.position().top,left:el.position().left,width:el.outerWidth(),height:el.outerHeight()});self.initSpinner(document.getElementById(overlayId))};evts[removeEvent]=function(){$("#"+overlayId).remove()};el.on(evts)};greppy.Styler.prototype.initSpinner=function(target,opts){opts=opts||{lines:11,length:0,width:10,radius:30,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:29,shadow:false,hwaccel:true,className:"spinner",zIndex:2e9};this.spinner=new Spinner(opts).spin(target)};greppy.app=new greppy.Application;